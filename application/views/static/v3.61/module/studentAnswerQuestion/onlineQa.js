define("module/studentAnswerQuestion/onlineQa",["lib/tizi_ajax/0.0.1/tizi_ajax","lib/artDialog/4.1.7/artDialog","lib/cookies/0.0.1/jquery.cookies"],function(require,exports){require("lib/tizi_ajax/0.0.1/tizi_ajax"),require("lib/artDialog/4.1.7/artDialog"),require("lib/cookies/0.0.1/jquery.cookies"),exports.init=function(){exports.aq_subject(),exports.get_grades(),exports.uploadImages(),exports.dosubmit(),exports.initUploadImages()},exports.dosubmit=function(){var str_tip=['<div class="md_qreason_tip">请输入该问题的详细描述。<em onclick="Student.aq_ask.close_event(this)">X</em></div>','<div class="md_qreason_tip">请选择问题原因。<em onclick="Student.aq_ask.close_event(this)">X</em></div>','<div class="md_qreason_tip">请选择学科。<em onclick="Student.aq_ask.close_event(this)">X</em></div>','<div class="md_qreason_tip">请选择年级分类。<em onclick="Student.aq_ask.close_event(this)">X</em></div>'];$("#content").blur(function(){$(".md_qreason_tip").remove(),$("#submitQuestion").removeClass().addClass("submitQuestion")}),$(".submitQuestion").live("click",function(){var id=$("#aq_question_id").val(),content=$("#content").html(),picture_urls="";$(".picture_urls").each(function(){picture_urls+=""===picture_urls?"":",",picture_urls+=$(this).attr("src")});var type=$('input[name="aq_question_type"]:checked').val(),grade=$("#grade_id").val(),point_ids="",subject_id=$("#subject_id").val();$('input[name="sub_item"]:checked').each(function(){point_ids+=""===point_ids?"":",",point_ids+=$(this).val()});var reward=$("#reward").val(),flag=!1,is_teacher=$("#is_teacher").val();if((""!==$.trim(content)||$(".picture_urls").length>-1)&&($("#submitQuestion").removeClass().addClass("submitQuestionGray"),$(".submitQuestion").attr("disabled",!0)),""==subject_id?($(".learn_branch").after(str_tip[2]),$(".submitQuestion").attr("disabled",!0)):""==grade&&($(".learn_branch").after(str_tip[3]),$(".submitQuestion").attr("disabled",!0)),(""!==$.trim(content)||$(".picture_urls").length>-1)&&""!=grade&&($("#submitQuestion").removeClass().addClass("submitQuestion"),$(".submitQuestion").removeAttr("disabled"),flag=!0),flag){if(id>0)if(is_teacher)var request_uri="/teacher/aq_teacher/send_edit";else var request_uri=baseUrlName+"student/aq_controller/edit";else var request_uri=baseUrlName+"student/aq_controller/ask";$.tizi_ajax({url:request_uri,type:"POST",dataType:"json",data:{specific:$("#specific").val(),teacher_id:$("#teacher_id").val(),content:content,picture_urls:picture_urls,type:type,subject_id:subject_id,grade:grade,point_ids:point_ids,reward:reward,question_id:id>0?id:0},success:function(json){$("#ask_page").length>0?0==json.errorcode?($.tiziDialog({content:json.error}),window.location.href=window.location.href):($.tiziDialog({content:"提交成功"}),window.location.href="/student/question/detail/"+json.error):1==json.errorcode?($.tiziDialog({content:"修改成功！",icon:"succeed"}),is_teacher?window.location.reload():window.location.href="/student/question/detail/"+id):($.tiziDialog({content:"修改失败",icon:"warning"}),window.location.href=window.location.href)},error:function(){$.tiziDialog({content:"系统繁忙，请稍后再试",icon:"error"})}})}})},exports.aq_subject=function(){$.ajax({url:baseUrlName+"student/aq_start/subject",type:"GET",dataType:"json",success:function(json){for(var options='<option value="0">请选择科目</option>',i=0;i<json.length;++i)options+='<option value="'+json[i].aq_subject_id+'">'+json[i].aq_subject_name+"</option>";$("#aq_subject").html(options),$("#aq_subject").css("display","")}})},exports.get_grades=function(){$("#aq_subject").live("change",function(){var subject_id=$(this).val();subject_id>0&&$("#aq_subject option[value='0']").attr("disabled","disabled"),$.ajax({url:baseUrlName+"student/aq_start/grade?subject_id="+subject_id,type:"GET",dataType:"json",success:function(json){for(var options='<option value="0">请选择年级</option>',i=0;i<json.length;++i)options+='<option value="'+json[i].aq_grade_id+'">'+json[i].aq_grade_name+"</option>";$("#aq_grades").html(options),$("#aq_grades").css("display","")}})}),$("#aq_grades").live("change",function(){var grade_id=$(this).val();grade_id>0&&$("#aq_grades option[value='0']").attr("disabled","disabled")})},exports.uploadImages=function(){var that=this;$(".aqupload").each(function(){var node=$(this),loading=staticUrlName+"image/answerquestion/loading.gif",upload_id=node.attr("id");$("#"+upload_id).uploadify({formData:$.tizi_token({session_id:$.cookies.get(baseSessID)},"post"),swf:staticBaseUrlName+staticVersion+"lib/uploadify/2.2/uploadify.swf",uploader:baseUrlName+"upload/aqask?id="+upload_id,multi:!1,buttonClass:"choseFileBtn",buttonText:"上传图片",fileTypeExts:"*.jpg; *.png;*.gif;*.bmp",fileSizeLimit:"2048KB",fileObjName:upload_id,width:102,height:28,overrideEvents:["onSelectError","onDialogClose"],onUploadStart:function(){$("."+upload_id).html('<img src="'+loading+'" class="imgloading"/>')},onSWFReady:function(){},onFallback:function(){$(".imgTips").html(noflash)},onSelectError:function(file,errorCode){switch(errorCode){case-110:$.tiziDialog({content:"文件 ["+file.name+"] 过大！每张图片不能超过2M"});break;case-120:$.tiziDialog({content:"文件 ["+file.name+"] 大小异常！不可以上传大小为0的文件"});break;case-130:$.tiziDialog({content:"文件 ["+file.name+"] 类型不正确！不可以上传错误的文件格式"})}return!1},onUploadSuccess:function(file,data){var json=JSON.parse(data);if(1==json.code){var img_path=json.img_path;that.drawImage(img_path,92,71,upload_id),$("."+upload_id).removeClass("red"),$("."+upload_id).addClass("upladpicSpan").removeClass("upladpic")}else $("."+upload_id).html("<b>"+json.msg+"</b>"),$("."+upload_id).addClass("red");$("."+upload_id).siblings(".clearpic").show(),$("."+upload_id).siblings(".clearpic").on("click",function(){$("."+upload_id).find("img").remove(),$("."+upload_id).siblings(".clearpic").hide(),$("."+upload_id).removeClass("red"),$("."+upload_id).removeClass("upladpicSpan").addClass("upladpic")})},onUploadComplete:function(){}})})},exports.drawImage=function(){var image=new Image,Img=new Image;image.src=src,image.onload=function(){image.width>width||image.height>height?(w=image.width/width,h=image.height/height,w>h?(Img.width=width,Img.height=image.height/w):(Img.height=height,Img.width=image.width/h)):(h=image.height/height,Img.width=image.width/h,Img.height=height),$("."+upload_id).html('<img src="'+src+'" class="picture_urls" width="'+Img.width+'" height="'+Img.height+'"/>')}},exports.initUploadImages=function(){var upladpic=$(".upladpic");upladpic.each(function(){var that=$(this),pics=$(this).find("img");1==pics.length&&(that.removeClass("upladpic").addClass("upladpicSpan"),that.siblings(".clearpic").show(),that.siblings(".clearpic").on("click",function(){that.find("img").remove(),$(this).hide(),that.removeClass("red"),that.removeClass("upladpicSpan").addClass("upladpic")}))})}});